name: Update M3U8 Every 5 Minutes

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  update-m3u8:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install axios
    
    - name: Update M3U8 file
      run: |
        node -e "
        const axios = require('axios');
        const fs = require('fs');
        
        async function update() {
          try {
            const response = await axios.get('https://kick.com/api/v2/channels/sgsafsfsfsfsfs');
            const data = response.data;
            const m3u8Url = data.playback_url;
            const isLive = data.livestream?.is_live;
            const title = data.livestream?.session_title || 'Kick Stream';
            
            let content = '#EXTM3U\\n';
            if (m3u8Url && isLive) {
              content += '#EXTINF:-1,' + title + '\\n';
              content += m3u8Url + '\\n';
            } else {
              content += '#EXTINF:-1,' + title + ' (OFFLINE)\\n';
              content += '# https://kick.com/sgsafsfsfsfsfs\\n';
            }
            
            fs.writeFileSync('index.m3u8', content);
            console.log('M3U8 updated successfully');
          } catch (error) {
            console.error('Error:', error.message);
            fs.writeFileSync('index.m3u8', '#EXTM3U\\n#EXTINF:-1,Error fetching\\n');
          }
        }
        
        update();
        "
    
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add index.m3u8
        git diff --quiet && git diff --staged --quiet || git commit -m "Update m3u8: $(date '+%H:%M')"
        git push
